using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Identity;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using UserRoles.Data;
using UserRoles.Models;

namespace UserRoles.Controllers
{
    [Authorize]
    public class ReportsController : Controller
    {
        private readonly AppDbContext _context;
        private readonly UserManager<Users> _userManager;

        public ReportsController(AppDbContext context, UserManager<Users> userManager)
        {
            _context = context;
            _userManager = userManager;
        }

        /* ================= USER REPORTS ================= */
        [Authorize(Roles = "Admin,Manager,User")]
        public async Task<IActionResult> UserReports(string userId)
        {
            var currentUserId = _userManager.GetUserId(User);

            if (User.IsInRole("User") && userId != currentUserId)
                return Forbid();

            var reports = await _context.DailyReports
                .Include(r => r.ApplicationUser)
                .Where(r => r.ApplicationUserId == userId)
                .OrderByDescending(r => r.Date)
                .ToListAsync();

            ViewBag.Today = DateTime.Today;
            ViewBag.HasToday = reports.Any(r => r.Date.Date == DateTime.Today);

            return View(reports);
        }

        /* ================= CREATE (USER ONLY) ================= */
        [Authorize(Roles = "User")]
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> CreateToday(string Task, string Note, List<string> ReportedTo)
        {
            var userId = _userManager.GetUserId(User)!;
            var today = DateTime.Today;

            if (today.DayOfWeek == DayOfWeek.Sunday)
            {
                TempData["Error"] = "Sunday reports are not allowed.";
                return RedirectToAction(nameof(UserReports), new { userId });
            }

            bool exists = await _context.DailyReports.AnyAsync(r =>
                r.ApplicationUserId == userId && r.Date == today);

            if (exists)
            {
                TempData["Error"] = "You already submitted today's report.";
                return RedirectToAction(nameof(UserReports), new { userId });
            }

            var report = new DailyReport
            {
                ApplicationUserId = userId,
                Date = today,
                Task = Task,
                Note = Note,
                ReportedTo = string.Join(", ", ReportedTo),
                CreatedAt = DateTime.UtcNow
            };

            _context.DailyReports.Add(report);
            await _context.SaveChangesAsync();

            return RedirectToAction(nameof(UserReports), new { userId });
        }

        /* ================= EDIT (ADMIN / MANAGER) ================= */
        [Authorize(Roles = "Admin,Manager")]
        public async Task<IActionResult> Edit(int id)
        {
            var report = await _context.DailyReports
                .Include(r => r.ApplicationUser)
                .FirstOrDefaultAsync(r => r.Id == id);

            if (report == null) return NotFound();
            return View(report);
        }

        [Authorize(Roles = "Admin,Manager")]
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> Edit(DailyReport model)
        {
            var report = await _context.DailyReports.FindAsync(model.Id);
            if (report == null) return NotFound();

            report.Task = model.Task;
            report.Note = model.Note;
            report.AdminComment = model.AdminComment;

            await _context.SaveChangesAsync();
            return RedirectToAction(nameof(UserReports), new { userId = report.ApplicationUserId });
        }

        /* ================= DELETE (ADMIN / MANAGER) ================= */
        [Authorize(Roles = "Admin,Manager")]
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> Delete(int id)
        {
            var report = await _context.DailyReports.FindAsync(id);
            if (report == null) return NotFound();

            _context.DailyReports.Remove(report);
            await _context.SaveChangesAsync();

            return RedirectToAction(nameof(UserReports), new { userId = report.ApplicationUserId });
        }
    }
}
