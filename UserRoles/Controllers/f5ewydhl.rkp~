using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Identity;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using UserRoles.Data;
using UserRoles.Models;
using UserRoles.ViewModels;

namespace UserRoles.Controllers
{
    [Authorize]
    public class ReportsController : Controller
    {
        private readonly AppDbContext _context;
        private readonly UserManager<Users> _userManager;

        public ReportsController(AppDbContext context, UserManager<Users> userManager)
        {
            _context = context;
            _userManager = userManager;
        }

        /* ================= ENTRY ================= */
        public IActionResult Index()
        {
            if (User.IsInRole("Admin") || User.IsInRole("Manager"))
                return RedirectToAction("Index", "Users");

            var userId = _userManager.GetUserId(User);
            return RedirectToAction(nameof(UserReports), new { userId });
        }

        /* ================= USER REPORTS ================= */
        [Authorize(Roles = "Admin,Manager,User")]
        public async Task<IActionResult> UserReports(string userId)
        {
            var currentUserId = _userManager.GetUserId(User);

            if (User.IsInRole("User") && userId != currentUserId)
                return Forbid();

            var reports = await _context.DailyReports
                .Where(r => r.ApplicationUserId == userId)
                .OrderByDescending(r => r.Date)
                .ThenByDescending(r => r.CreatedAt)
                .ToListAsync();

            // ✅ BUSINESS DATE (LOCAL)
            var today = DateTime.Today;

            ViewBag.Today = today;
            ViewBag.HasTodayReport = reports.Any(r => r.Date == today);

            return View(reports);
        }

        /* ================= CREATE TODAY REPORT ================= */
        [Authorize(Roles = "User")]
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> CreateToday(
            string Task,
            string Note,
            List<string> ReportedTo)
        {
            var userId = _userManager.GetUserId(User)!;

            // ✅ BUSINESS DATE (LOCAL)
            var today = DateTime.Today;

            /* ❌ BLOCK SUNDAY */
            if (today.DayOfWeek == DayOfWeek.Sunday)
            {
                TempData["Error"] = "Sunday reports are not allowed.";
                return RedirectToAction(nameof(UserReports), new { userId });
            }

            /* ❌ ONE REPORT PER DAY */
            bool exists = await _context.DailyReports.AnyAsync(r =>
                r.ApplicationUserId == userId &&
                r.Date == today);

            if (exists)
            {
                TempData["Error"] = "You already submitted today's report.";
                return RedirectToAction(nameof(UserReports), new { userId });
            }

            if (string.IsNullOrWhiteSpace(Task) || string.IsNullOrWhiteSpace(Note))
            {
                TempData["Error"] = "Task and Note are required.";
                return RedirectToAction(nameof(UserReports), new { userId });
            }

            if (ReportedTo == null || !ReportedTo.Any())
            {
                TempData["Error"] = "Please select Manager or Admin.";
                return RedirectToAction(nameof(UserReports), new { userId });
            }

            var report = new DailyReport
            {
                ApplicationUserId = userId,
                Date = today,                      // ✅ CORRECT BUSINESS DATE
                Task = Task.Trim(),
                Note = Note.Trim(),
                ReportedTo = string.Join(", ", ReportedTo),
                CreatedAt = DateTime.UtcNow        // ✅ POSTGRES SAFE
            };

            _context.DailyReports.Add(report);
            await _context.SaveChangesAsync();

            TempData["Success"] = "Report submitted successfully.";
            return RedirectToAction(nameof(UserReports), new { userId });
        }

        /* ================= DETAILS ================= */
        public async Task<IActionResult> Details(int id)
        {
            var report = await _context.DailyReports
                .AsNoTracking()
                .FirstOrDefaultAsync(r => r.Id == id);

            if (report == null)
                return NotFound();

            var currentUserId = _userManager.GetUserId(User);
            if (User.IsInRole("User") && report.ApplicationUserId != currentUserId)
                return Forbid();

            var owner = await _userManager.FindByIdAsync(report.ApplicationUserId);

            return View(new ReportViewModel
            {
                Id = report.Id,
                ApplicationUserId = report.ApplicationUserId,
                UserName = owner?.UserName,
                FirstName = owner?.FirstName,
                Date = report.Date,
                Task = report.Task,
                Note = report.Note,
                ReportedTo = report.ReportedTo,
                CreatedAt = report.CreatedAt
            });
        }
    }
}
