@model IEnumerable<UserRoles.Models.DailyReport>

@{
    ViewData["Title"] = "Reports";

    bool isUser = User.IsInRole("User");
    bool canEdit = User.IsInRole("Admin") || User.IsInRole("Manager");

    var today = DateTime.UtcNow.Date;

    var todayReport = Model.FirstOrDefault(r => r.Date == today);
    var previousReports = Model
        .Where(r => r.Date < today)
        .OrderByDescending(r => r.Date)
        .ToList();
}

<h2 class="mb-3">Reports</h2>

<!-- ================= SUBMIT TODAY REPORT ================= -->
@if (isUser && todayReport == null)
{
    <div class="card mb-4 shadow-sm">
        <div class="card-header fw-bold">
            Submit Today’s Report
        </div>

        <div class="card-body">
            <form asp-action="CreateToday" method="post">
                @Html.AntiForgeryToken()

                <!-- DATE (READ ONLY) -->
                <div class="mb-2">
                    <label class="form-label">Date</label>
                    <input class="form-control"
                           value="@today.ToString("yyyy-MM-dd")"
                           readonly />
                </div>

                <!-- TASK -->
                <div class="mb-2">
                    <label class="form-label">Task</label>
                    <input name="Task"
                           class="form-control"
                           placeholder="Enter today's task"
                           required />
                </div>

                <!-- NOTE -->
                <div class="mb-2">
                    <label class="form-label">Note</label>
                    <textarea name="Note"
                          class="form-control"
                          rows="3"
                          placeholder="Work details / comments"
                          required></textarea>
                </div>

                <!-- REPORTED TO (CHECKBOXES) -->
                <div class="mb-3">
                    <label class="form-label fw-semibold">Reported To</label>

                    <div class="form-check">
                        <input class="form-check-input"
                               type="checkbox"
                               name="ReportedTo"
                               value="Manager"
                               id="reportManager">
                        <label class="form-check-label" for="reportManager">
                            Manager
                        </label>
                    </div>

                    <div class="form-check">
                        <input class="form-check-input"
                               type="checkbox"
                               name="ReportedTo"
                               value="Admin"
                               id="reportAdmin">
                        <label class="form-check-label" for="reportAdmin">
                            Admin
                        </label>
                    </div>
                </div>

                <button class="btn btn-success">
                    Submit Today Report
                </button>
            </form>
        </div>
    </div>
}

<!-- ================= REPORTS HISTORY ================= -->
<div class="card shadow-sm">
    <div class="card-header fw-bold">
        Reports History
    </div>

    <div class="card-body p-0">
        <table class="table mb-0 table-striped">
            <thead class="table-light">
                <tr>
                    <th style="width:160px;">Date</th>
                    <th>Task</th>
                    <th>Note</th>
                    <th>Reported To</th>
                    <th style="width:200px;">Actions</th>
                </tr>
            </thead>

            <tbody>

                <!-- ========== TODAY REPORT (ONLY ONE) ========== -->
                @if (todayReport != null)
                {
                    <tr class="table-success fw-semibold">
                        <td>
                            @todayReport.Date.ToString("yyyy-MM-dd")
                            <span class="badge bg-success ms-2">Today</span>
                        </td>

                        <td>@todayReport.Task</td>
                        <td>@todayReport.Note</td>
                        <td>@todayReport.ReportedTo</td>

                        <td class="d-flex gap-1">
                            <a asp-action="Details"
                               asp-route-id="@todayReport.Id"
                               class="btn btn-info btn-sm">
                                Details
                            </a>

                            @if (canEdit)
                            {
                                <a asp-action="Edit"
                                   asp-route-id="@todayReport.Id"
                                   class="btn btn-warning btn-sm">
                                    Edit
                                </a>

                                <a asp-action="Delete"
                                   asp-route-id="@todayReport.Id"
                                   class="btn btn-danger btn-sm"
                                   onclick="return confirm('Are you sure you want to delete this report?');">
                                    Delete
                                </a>
                            }
                        </td>
                    </tr>
                }

                <!-- ========== PREVIOUS REPORTS ========== -->
                @foreach (var r in previousReports)
                {
                    <tr>
                        <td>@r.Date.ToString("yyyy-MM-dd")</td>
                        <td>@r.Task</td>
                        <td>@r.Note</td>
                        <td>@r.ReportedTo</td>

                        <td class="d-flex gap-1">
                            <a asp-action="Details"
                               asp-route-id="@r.Id"
                               class="btn btn-info btn-sm">
                                Details
                            </a>

                            @if (canEdit)
                            {
                                <a asp-action="Edit"
                                   asp-route-id="@r.Id"
                                   class="btn btn-warning btn-sm">
                                    Edit
                                </a>

                                <a asp-action="Delete"
                                   asp-route-id="@r.Id"
                                   class="btn btn-danger btn-sm"
                                   onclick="return confirm('Are you sure you want to delete this report?');">
                                    Delete
                                </a>
                            }
                        </td>
                    </tr>
                }

                @if (todayReport == null && !previousReports.Any())
                {
                    <tr>
                        <td colspan="5" class="text-center text-muted py-4">
                            No reports available.
                        </td>
                    </tr>
                }

            </tbody>
        </table>
    </div>
</div>

<!-- ================= BACK BUTTON ================= -->
@if (User.IsInRole("Admin") || User.IsInRole("Manager"))
{
    <div class="mt-3">
        <a asp-action="Users"
           asp-controller="Reports"
           class="btn btn-outline-dark">
            ← Back to Users
        </a>
    </div>
}
